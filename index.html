<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S Sport Plus - Pusula (Dashboard)</title>
<!-- Mevcut ƒ∞kon Setin -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<!-- Grafik K√ºt√ºphanesi (Chart.js) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<style>
/* --- MEVCUT STƒ∞LLERƒ∞N (Style.docx'ten alƒ±ndƒ±) --- */
:root { 
    --primary: #0e1b42; 
    --secondary: #fabb00; 
    --bg: #f4f6f8; 
    --card-bg: #ffffff; 
    --accent: #d32f2f; 
    --success: #2e7d32; 
    --info: #0288d1; 
    --warning: #ed6c02; 
    --sales: #10b981; 
    --quiz: #8e24aa; 
    --text-dark: #2c3e50;
    --text-light: #95a5a6;
}
body { 
    margin: 0; padding: 0; 
    font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif; 
    background-color: var(--bg); 
    color: var(--text-dark);
    user-select: none; 
    overflow-x: hidden;
}
/* Login & Main Layout */
#login-screen { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; 
    display: flex; justify-content: center; align-items: center;
    background: #0e1b42; 
}
.login-card {
    background: #1c2438; padding: 25px 40px; border-radius: 12px; text-align: center;
    width: 300px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    border: 1px solid rgba(255,255,255,0.05);
}
.login-logo-img { width: 90px; height: auto; margin-bottom: 0px; filter: drop-shadow(0 0 10px rgba(250, 187, 0, 0.3)); }
.login-input { width: 100%; padding: 12px; margin: 8px 0; background: #2c344a; color: #fff; border: 1px solid #3a4563; border-radius: 6px; text-align: center; outline: none; transition: 0.3s; }
.login-input:focus { border-color: var(--secondary); background: #323c54; }
.login-btn { width: 100%; padding: 12px; background: var(--secondary); border: none; border-radius: 6px; font-weight: 700; cursor: pointer; margin-top: 15px; color: #0e1b42; transition: 0.2s; }
.login-btn:hover { background: #e0a800; }
.loading-text { font-size: 0.8rem; color: #666; margin-top: 10px; display: none; }
#maintenance-screen { display: none !important; }
#main-app { display: none; }

/* Header & Nav */
.header { background: #0e1b42; color: white; padding: 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
.header-content-limit { width: 100%; max-width: 1600px; margin-right: auto; margin-left: 0; padding: 5px 25px 0px 10px; box-sizing: border-box; }
.header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0px; }
.brand-area { display: flex; align-items: center; gap: 10px; }
.brand-img { height: 65px; width: 65px; object-fit: contain; filter: drop-shadow(0 0 5px rgba(250, 187, 0, 0.3)); }
.brand-text .main-text { font-size: 1.0rem; font-weight: 700; color: #fff; }
.brand-text .sub-text { font-size: 1.0rem; font-weight: 300; color: rgba(255,255,255,0.6); border-left: 1px solid rgba(255,255,255,0.3); padding-left: 8px; }
.user-btn { background: transparent; border: none; color: #eee; padding: 6px 10px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
.user-avatar { width: 26px; height: 26px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--secondary); }
.dropdown-menu { display: none; position: absolute; right: 0; top: 110%; background-color: #1c2438; min-width: 180px; box-shadow: 0 8px 25px rgba(0,0,0,0.5); border-radius: 6px; z-index: 2000; }
.dropdown-menu.show { display: block; }
.dropdown-item { display: flex; align-items: center; gap: 10px; padding: 12px 15px; color: #ddd; text-decoration: none; font-size: 0.85rem; transition: 0.2s; }
.dropdown-item:hover { background-color: #2c344a; color: #fff; }

/* Filter & Controls */
.control-wrapper { display: flex; align-items: center; justify-content: flex-start; gap: 15px; flex-wrap: wrap; }
.search-container { position: relative; width: 300px; }
#searchInput { width: 100%; padding: 6px 15px 6px 35px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 4px; color: white; box-sizing: border-box; }
.search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: rgba(255, 255, 255, 0.5); }
.filter-container { display: flex; gap: 6px; align-items: center; overflow-x: auto; padding-bottom: 2px; }
.filter-btn { background-color: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.15); color: rgba(255, 255, 255, 0.75); padding: 5px 10px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.75rem; white-space: nowrap; }
.filter-btn:hover { background-color: rgba(255, 255, 255, 0.1); color: white; }
.filter-btn.active { background-color: #fabb00 !important; color: #0e1b42 !important; font-weight: 700; }
.divider { width: 1px; height: 18px; background: rgba(255,255,255,0.15); margin: 0 4px; }

/* Ticker */
.news-ticker-box { background: #0a1532; border-top: 1px solid rgba(255, 255, 255, 0.05); padding: 0 25px; height: 25px; display: flex; align-items: center; gap: 15px; cursor: pointer; overflow: hidden; }
.ticker-label { font-size: 0.65rem; color: #fabb00; font-weight: 800; display: flex; align-items: center; gap: 6px; background: #0a1532; z-index: 5; height: 100%; padding-right: 15px; }
.pulse-dot { width: 5px; height: 5px; background: var(--secondary); border-radius: 50%; animation: pulse 2s infinite; }
.ticker-scroll-wrapper { flex-grow: 1; overflow: hidden; position: relative; height: 100%; display: flex; align-items: center; }
.ticker-content { font-size: 0.7rem; color: rgba(255, 255, 255, 0.9); white-space: nowrap; position: absolute; left: 100%; animation: ticker-scroll 30s linear infinite; }
@keyframes ticker-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%) translateX(-200px); } }

/* Cards Grid */
.container { padding: 25px; max-width: 1600px; margin: 0 auto; }
.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
.card { background: var(--card-bg); border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #eaedf2; border-left: 4px solid var(--info); display: flex; flex-direction: column; transition: transform 0.2s; position: relative; }
.card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.06); }
.card.Teknik { border-left-color: var(--primary); }
.card.ƒ∞kna { border-left-color: var(--accent); } 
.card.Kampanya { border-left-color: var(--success); }
.card-header { display: flex; justify-content: space-between; margin-bottom: 12px; }
.card-title { font-weight: 600; font-size: 1.05rem; color: #2c3e50; }
.badge { font-size: 0.65rem; padding: 3px 6px; background: #f7f9fc; font-weight: 600; color: #7f8c8d; border: 1px solid #edf2f7; border-radius: 3px; }
.card-content { font-size: 0.9rem; color: #555; margin-bottom: 15px; flex-grow: 1; cursor: pointer; }
.script-box { background: #fffdf5; border: 1px solid #f9f1d8; padding: 10px; border-radius: 4px; font-style: italic; color: #666; margin-top: auto; font-size: 0.85rem; }
.card-actions { margin-top: 12px; display: flex; justify-content: flex-end; gap: 8px; }
.btn-copy { background: #0e1b42; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
.new-badge { position: absolute; top: 12px; left: -4px; background: #2e7d32; color: white; font-size: 0.6rem; padding: 2px 5px; border-radius: 0 3px 3px 0; font-weight: bold; }
.icon-wrapper { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
.fav-icon { color: #dce0e6; cursor: pointer; transition: 0.2s; }
.fav-icon.active { color: var(--secondary); }
.edit-icon { color: var(--secondary); cursor: pointer; display: none; padding: 5px; background: white; border-radius: 50%; border:1px solid #eee; }
body.editing .edit-icon { display: block !important; }

/* Modals */
.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(14, 27, 66, 0.8); z-index: 5000; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
.modal-content { background: white; width: 90%; max-width: 800px; border-radius: 8px; padding: 30px; position: relative; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
.close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #999; }

/* --- YENƒ∞ DASHBOARD CSS (BURAYA EKLENDƒ∞) --- */
.dash-grid-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-top: 20px;
}
.dash-card {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    border: 1px solid #f0f0f0;
    transition: transform 0.2s;
    position: relative;
    overflow: hidden;
}
.dash-card:hover { transform: translateY(-2px); }
.dash-card-icon {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    opacity: 0.2;
}
.dash-card-title { font-size: 0.8rem; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.dash-card-value { font-size: 2.5rem; font-weight: 800; color: #0e1b42; margin-top: 5px; }
.dash-card-sub { font-size: 0.8rem; color: #94a3b8; margin-top: 5px; }
.dash-main-area {
    grid-column: span 3;
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
}
.dash-chart-box {
    background: white;
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #f0f0f0;
    height: 300px;
}
.dash-list-box {
    background: white;
    border-radius: 12px;
    border: 1px solid #f0f0f0;
    overflow: hidden;
    height: 300px;
    display: flex;
    flex-direction: column;
}
.dash-list-header {
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
    font-weight: bold;
    color: #0e1b42;
    background: #f8fafc;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.dash-list-content {
    overflow-y: auto;
    flex-grow: 1;
}
.dash-list-item {
    padding: 12px 15px;
    border-bottom: 1px solid #f1f5f9;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
}
.dash-list-item:last-child { border-bottom: none; }
.dash-score-badge {
    padding: 4px 8px;
    border-radius: 6px;
    font-weight: bold;
    font-size: 0.8rem;
}
.score-green { background: #dcfce7; color: #166534; }
.score-yellow { background: #fef9c3; color: #854d0e; }
.score-red { background: #fee2e2; color: #991b1b; }

/* Responsive Dashboard */
@media (max-width: 900px) {
    .dash-grid-container { grid-template-columns: 1fr; }
    .dash-main-area { grid-template-columns: 1fr; display: flex; flex-direction: column; }
    .dash-main-area > * { grid-column: span 1; }
}

</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
    <div class="login-card">
        <img src="favicon.png" alt="Logo" class="login-logo-img" onerror="this.style.display='none'">
        <h2 style="color:white; font-weight:300; margin-top:10px;">S Sport Plus <strong style="color:#fabb00;">Pusula</strong></h2>
        <p style="opacity:0.6; font-size:0.9rem; margin-bottom:20px;">Personel Giri≈üi</p>
        <input type="text" id="usernameInput" class="login-input" placeholder="Kullanƒ±cƒ± Adƒ±">
        <input type="password" id="passInput" class="login-input" placeholder="≈ûifre" onkeyup="enterBas(event)">
        <button class="login-btn" onclick="girisYap()">Giri≈ü Yap</button>
        <div id="loading-msg" class="loading-text">Baƒülanƒ±yor...</div>
        <p id="error-msg" style="color:#ef5350; display:none; margin-top:10px; font-size:0.9rem;">Hatalƒ± Kullanƒ±cƒ± Adƒ± veya ≈ûifre!</p>
    </div>
</div>

<!-- BAKIM -->
<div id="maintenance-screen">
    <div style="text-align:center; color:white;">
        <span style="font-size: 4rem;">üë®‚Äçüè´</span>
        <h1>Sistem Mola Verdi!</h1>
        <p>Bakƒ±m √ßalƒ±≈ümasƒ± s√ºr√ºyor... üöÄ</p>
    </div>
</div>

<!-- MAIN APP -->
<div id="main-app">
    <div class="header">
        <div class="header-content-limit">
            <div class="header-top">
                <div class="brand-area">
                    <!-- Placeholder Logo -->
                    <div style="width:40px; height:40px; background:#fabb00; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#0e1b42;">S</div>
                    <div class="brand-text">
                        <span class="main-text">S Sport Plus</span>
                        <span class="sub-text">Temsilci Pusulasƒ±</span>
                    </div>
                </div>
                <div class="header-controls">
                    <div class="user-menu-wrapper">
                        <button id="adminBtn" class="user-btn" onclick="toggleUserDropdown()">
                            <div class="user-avatar"><i class="fas fa-user"></i></div>
                            <span id="user-display">Misafir</span>
                            <i class="fas fa-chevron-down" id="user-menu-arrow" style="font-size:0.7rem; opacity:0.5; transition:0.3s;"></i>
                        </button>
                        <div id="userDropdown" class="dropdown-menu">
                            <div class="dropdown-header"><span style="font-size:0.8rem; color:#999;">Hesap ƒ∞≈ülemleri</span></div>
                            <a href="javascript:void(0)" class="dropdown-item" onclick="changePasswordPopup()"><i class="fas fa-key"></i> ≈ûifre Deƒüi≈ütir</a>
                            <a href="javascript:void(0)" class="dropdown-item" id="dropdownAddCard" style="display:none;" onclick="addNewCardPopup()"><i class="fas fa-plus" style="color:var(--success);"></i> ƒ∞√ßerik Ekle</a>
                            <a href="javascript:void(0)" class="dropdown-item" id="dropdownQuickEdit" style="display:none;" onclick="toggleEditMode()"><i class="fas fa-pen" style="color:var(--secondary);"></i> D√ºzenlemeyi A√ß</a>
                            <div class="dropdown-divider"></div>
                            <a href="javascript:void(0)" class="dropdown-item logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> √áƒ±kƒ±≈ü Yap</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="control-wrapper">
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" placeholder="ƒ∞√ßeriklerde hƒ±zlƒ± ara..." onkeyup="filterContent()">
                </div>
                <div class="filter-container">
                    <button class="filter-btn btn-fav" onclick="filterCategory(this, 'fav')"><i class="fas fa-star"></i></button>
                    <button class="filter-btn btn-all active" onclick="filterCategory(this, 'all')"><i class="fas fa-layer-group"></i> T√ºm√º</button>
                    <button class="filter-btn" onclick="filterCategory(this, 'Teknik')"><i class="fas fa-wrench"></i> Teknik</button>
                    <button class="filter-btn" onclick="filterCategory(this, 'ƒ∞kna')"><i class="fas fa-hand-holding-dollar"></i> ƒ∞kna</button>
                    <button class="filter-btn" onclick="filterCategory(this, 'Kampanya')"><i class="fas fa-gift"></i> Kampanya</button>
                    <button class="filter-btn" onclick="filterCategory(this, 'Bilgi')"><i class="fas fa-info-circle"></i> Bilgi</button>
                    <div class="divider"></div>
                    <button class="filter-btn link-btn" onclick="openQualityArea()"><i class="fas fa-chart-pie"></i> Kalite</button>
                </div>
            </div>
        </div>
        
        <div class="news-ticker-box" onclick="openNews()">
            <div class="ticker-label"><span class="pulse-dot"></span> DUYURU</div>
            <div class="ticker-scroll-wrapper">
                <div id="ticker-content" class="ticker-content">Veriler y√ºkleniyor...</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="loading" style="text-align:center; padding:40px; color:#999;">
            <i class="fas fa-circle-notch fa-spin fa-2x"></i><br>
            <span style="font-size:0.9rem; margin-top:10px; display:block;">Veriler g√ºncelleniyor...</span>
        </div>
        <div class="grid" id="cardGrid"></div>
    </div>
</div>

<!-- NEWS MODAL -->
<div id="news-modal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('news-modal')">&times;</span>
        <h2 style="color:var(--primary);">üì¢ Duyurular</h2>
        <div id="news-container"></div>
    </div>
</div>

<!-- KALƒ∞TE (DASHBOARD) MODAL - YENƒ∞LENDƒ∞ -->
<div id="quality-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 1000px; background: #f8f9fa;">
        <span class="close-modal" onclick="closeModal('quality-modal')">&times;</span>
        
        <!-- √úst Ba≈ülƒ±k ve Filtreler -->
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
            <div>
                <h2 style="margin:0; color:var(--primary);"><i class="fa-solid fa-chart-line"></i> Kalite Performans</h2>
                <p style="margin:5px 0 0 0; font-size:0.8rem; color:#666;">G√ºncel d√∂nem performans √∂zeti</p>
            </div>
            
            <!-- Admin Kontrolleri (Varsa) -->
            <div id="admin-quality-controls" style="display:none; gap:10px;">
                <select id="agent-select-admin" class="swal2-input" onchange="fetchEvaluationsForAgent()" style="width: 200px; padding:5px; height:35px; margin:0; font-size:0.8rem;"></select>
                <button class="filter-btn active" onclick="logEvaluationPopup()"><i class="fas fa-plus"></i> Ekle</button>
                <button class="filter-btn" style="background:var(--success); border-color:var(--success); color:white;" onclick="exportEvaluations()"><i class="fas fa-file-csv"></i> Rapor</button>
            </div>
        </div>

        <!-- KPI Kartlarƒ± -->
        <div class="dash-grid-container">
            <!-- Kart 1: Puan -->
            <div class="dash-card" style="border-left: 4px solid var(--info);">
                <div class="dash-card-icon" style="background: var(--info); color: var(--info);"><i class="fa-solid fa-star"></i></div>
                <div class="dash-card-title">Genel Kalite Puanƒ±</div>
                <div class="dash-card-value" id="dash-total-score">--</div>
                <div class="dash-card-sub">
                    <select id="month-select-filter" onchange="fetchEvaluationsForAgent()" style="border:none; background:transparent; font-size:0.8rem; font-weight:bold; color:#666; cursor:pointer;"></select>
                    d√∂nemi
                </div>
            </div>

            <!-- Kart 2: Adet -->
            <div class="dash-card" style="border-left: 4px solid var(--success);">
                <div class="dash-card-icon" style="background: var(--success); color: var(--success);"><i class="fa-solid fa-headset"></i></div>
                <div class="dash-card-title">Deƒüerlendirilen √áaƒürƒ±</div>
                <div class="dash-card-value" id="dash-total-count">--</div>
                <div class="dash-card-sub"><span style="color:var(--success);">Aktif</span> performans kaydƒ±</div>
            </div>

            <!-- Kart 3: Hedef (Statik √ñrnek) -->
            <div class="dash-card" style="border-left: 4px solid var(--warning);">
                <div class="dash-card-icon" style="background: var(--warning); color: var(--warning);"><i class="fa-solid fa-bullseye"></i></div>
                <div class="dash-card-title">Hedef Tutma</div>
                <div class="dash-card-value" id="dash-target-rate">--%</div>
                <div class="dash-card-sub">Hedef puan: 90+</div>
            </div>

            <!-- Ana ƒ∞√ßerik: Grafik ve Liste -->
            <div class="dash-main-area">
                <!-- Grafik -->
                <div class="dash-chart-box">
                    <canvas id="qualityChart"></canvas>
                </div>

                <!-- Son ƒ∞≈ülemler Listesi -->
                <div class="dash-list-box">
                    <div class="dash-list-header">
                        <span>Son Deƒüerlendirmeler</span>
                        <span style="font-size:0.7rem; color:#999;" id="list-subtitle">T√ºm liste i√ßin a≈üaƒüƒ± kaydƒ±rƒ±n</span>
                    </div>
                    <div class="dash-list-content" id="evaluations-list-dashboard">
                        <!-- JS ile dolacak -->
                        <div style="padding:20px; text-align:center; color:#ccc;">Veri bekleniyor...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Klasik Liste (Gizli/Yedek olarak tutuyoruz veya a≈üaƒüƒ±ya ekliyoruz) -->
        <div id="evaluations-list" style="display:none;"></div>

    </div>
</div>

<div class="crafted-by-badge">Crafted by Doƒüu≈ü Yal√ßƒ±nkaya</div>

<script>
// --- GLOBAL DEƒûƒ∞≈ûKENLER ---
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby3kd04k2u9XdVDD1-vdbQQAsHNW6WLIn8bNYxTlVCL3U1a0WqZo6oPp9zfBWIpwJEinQ/exec";
const BAKIM_MODU = false;
let database = [], newsData = [], activeCards = [];
let currentUser = "", isAdminMode = false, sessionTimeout;
const MONTH_NAMES = ["Ocak", "≈ûubat", "Mart", "Nisan", "Mayƒ±s", "Haziran", "Temmuz", "Aƒüustos", "Eyl√ºl", "Ekim", "Kasƒ±m", "Aralƒ±k"];
let allEvaluationsData = [];
let qualityChartInstance = null; // Grafik instance'ƒ±

document.addEventListener('DOMContentLoaded', () => {
    checkSession();
});

// --- SESSION & LOGIN ---
function checkSession() {
    const savedUser = localStorage.getItem("sSportUser");
    const savedToken = localStorage.getItem("sSportToken");
    const savedRole = localStorage.getItem("sSportRole");
    if (savedUser && savedToken) {
        currentUser = savedUser;
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("user-display").innerText = currentUser;
        checkAdmin(savedRole);
        startSessionTimer();
        if (BAKIM_MODU) document.getElementById("maintenance-screen").style.display = "flex";
        else {
            document.getElementById("main-app").style.display = "block";
            loadContentData();
        }
    }
}
function enterBas(e) { if (e.key === "Enter") girisYap(); }
function girisYap() {
    const uName = document.getElementById("usernameInput").value.trim();
    const uPass = document.getElementById("passInput").value.trim();
    if(!uName || !uPass) return;
    document.getElementById("loading-msg").style.display = "block";
    
    // ≈ûifre hashleme ve Fetch i≈ülemi (√ñzetlendi)
    const hashedPass = CryptoJS.SHA256(uPass).toString();
    fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action: "login", username: uName, password: hashedPass })
    }).then(r=>r.json()).then(data => {
        document.getElementById("loading-msg").style.display = "none";
        if (data.result === "success") {
            currentUser = data.username;
            localStorage.setItem("sSportUser", currentUser);
            localStorage.setItem("sSportToken", data.token);
            localStorage.setItem("sSportRole", data.role);
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("user-display").innerText = currentUser;
            checkAdmin(data.role);
            startSessionTimer();
            document.getElementById("main-app").style.display = "block";
            loadContentData();
        } else {
            document.getElementById("error-msg").style.display = "block";
        }
    }).catch(e=>console.error(e));
}
function checkAdmin(role) {
    isAdminMode = (role === "admin");
    const addCardDropdown = document.getElementById('dropdownAddCard');
    const quickEditDropdown = document.getElementById('dropdownQuickEdit');
    if(isAdminMode) {
        if(addCardDropdown) addCardDropdown.style.display = 'flex';
        if(quickEditDropdown) quickEditDropdown.style.display = 'flex';
    } else {
        if(addCardDropdown) addCardDropdown.style.display = 'none';
        if(quickEditDropdown) quickEditDropdown.style.display = 'none';
    }
}
function logout() {
    localStorage.removeItem("sSportUser"); localStorage.removeItem("sSportToken"); localStorage.removeItem("sSportRole");
    location.reload();
}
function startSessionTimer() {
    if (sessionTimeout) clearTimeout(sessionTimeout);
    sessionTimeout = setTimeout(() => { alert("Oturum s√ºresi doldu."); logout(); }, 3600000);
}

// --- DATA & UI ---
function loadContentData() {
    document.getElementById('loading').style.display = 'block';
    fetch(SCRIPT_URL, {
        method: 'POST', headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action: "fetchData" })
    }).then(r=>r.json()).then(data => {
        document.getElementById('loading').style.display = 'none';
        if (data.result === "success") {
            const rawData = data.data;
            database = rawData.filter(i => ['card','bilgi','teknik','kampanya','ikna'].includes(i.Type.toLowerCase()));
            newsData = rawData.filter(i => i.Type.toLowerCase() === 'news');
            activeCards = database;
            renderCards(database);
            startTicker();
        }
    });
}
function renderCards(data) {
    const container = document.getElementById('cardGrid');
    container.innerHTML = '';
    if (data.length === 0) { container.innerHTML = '<div style="color:#777;">Kayƒ±t yok.</div>'; return; }
    data.forEach(item => {
        let html = `<div class="card ${item.Category}">
            <div class="card-header"><h3 class="card-title">${item.Title}</h3><span class="badge">${item.Category}</span></div>
            <div class="card-content" onclick="showCardDetail('${item.Title}', '${item.Text}')">
                <div class="card-text-truncate">${item.Text}</div>
            </div>
            <div class="script-box">${item.Script || ''}</div>
            <div class="card-actions">
                ${item.Link ? `<a href="${item.Link}" target="_blank" class="btn-copy">Link</a>` : ''}
                <button class="btn-copy" onclick="copyText('${item.Script}')">Kopyala</button>
            </div>
        </div>`;
        container.innerHTML += html;
    });
}
function filterCategory(btn, cat) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    let filtered = database;
    if(cat !== 'all') filtered = filtered.filter(i => i.Category === cat);
    renderCards(filtered);
}
function filterContent() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const filtered = database.filter(i => i.Title.toLowerCase().includes(search) || i.Text.toLowerCase().includes(search));
    renderCards(filtered);
}
function showCardDetail(t, txt) { Swal.fire({ title: t, html: txt, width: '600px' }); }
function copyText(t) { navigator.clipboard.writeText(t); Swal.fire({toast:true, position:'top-end', icon:'success', title:'Kopyalandƒ±', showConfirmButton:false, timer:1500}); }

// --- TICKER ---
function startTicker() {
    const t = document.getElementById('ticker-content');
    const activeNews = newsData.filter(i => i.Status !== 'Pasif');
    if(activeNews.length===0) { t.innerHTML = "Duyuru yok."; return; }
    let txt = activeNews.map(i => `<span style="color:#fabb00;">[${i.Date ? i.Date.split('T')[0] : ''}]</span> ${i.Title}: ${i.Text}`).join(' &nbsp; ‚Ä¢ &nbsp; ');
    t.innerHTML = txt + ' &nbsp; ‚Ä¢ &nbsp; ' + txt;
}
function openNews() {
    const c = document.getElementById('news-container'); c.innerHTML = '';
    newsData.forEach(i => {
        c.innerHTML += `<div class="news-item" style="border-left:4px solid var(--primary); padding:10px; margin-bottom:10px; background:#f9f9f9;">
            <strong>${i.Title}</strong><br><span style="font-size:0.9rem;">${i.Text}</span>
        </div>`;
    });
    document.getElementById('news-modal').style.display = 'flex';
}
function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function toggleUserDropdown() { document.getElementById('userDropdown').classList.toggle('show'); }

// --- DASHBOARD & QUALITY LOGIC (YENƒ∞LENEN KISIM) ---
function openQualityArea() {
    document.getElementById('quality-modal').style.display = 'flex';
    document.getElementById('admin-quality-controls').style.display = isAdminMode ? 'flex' : 'none';
    
    // Ay Filtresini Doldur
    const selectEl = document.getElementById('month-select-filter');
    selectEl.innerHTML = '';
    const now = new Date();
    for (let i = 0; i < 6; i++) {
        let d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        let val = `${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;
        let txt = `${MONTH_NAMES[d.getMonth()]} ${d.getFullYear()}`;
        let opt = document.createElement('option'); opt.value = val; opt.textContent = txt;
        selectEl.appendChild(opt);
    }

    // Admin Listesi (Varsa)
    if (isAdminMode) {
        fetch(SCRIPT_URL, {
            method: 'POST', body: JSON.stringify({ action: "getUserList", username: currentUser })
        }).then(r=>r.json()).then(data => {
            if (data.result === "success") {
                const sel = document.getElementById('agent-select-admin');
                sel.innerHTML = `<option value="all">-- T√ºm Ekip --</option>` + data.users.map(u => `<option value="${u.name}">${u.name}</option>`).join('');
            }
        });
    }

    // ƒ∞lk Veriyi √áek
    fetchEvaluationsForAgent(isAdminMode ? 'all' : currentUser);
}

function fetchEvaluationsForAgent(forcedName) {
    const dashboardList = document.getElementById('evaluations-list-dashboard');
    dashboardList.innerHTML = '<div style="padding:20px; text-align:center;"><i class="fas fa-circle-notch fa-spin"></i> Veriler analiz ediliyor...</div>';
    
    let target = forcedName || (isAdminMode ? document.getElementById('agent-select-admin').value : currentUser);
    const selectedMonth = document.getElementById('month-select-filter').value;

    fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action: "fetchEvaluations", targetAgent: target, username: currentUser })
    }).then(r=>r.json()).then(data => {
        if (data.result === "success") {
            allEvaluationsData = data.evaluations;
            updateDashboardUI(allEvaluationsData, selectedMonth);
        } else {
            dashboardList.innerHTML = '<div style="color:red; text-align:center;">Veri hatasƒ±.</div>';
        }
    });
}

function updateDashboardUI(data, monthFilter) {
    // 1. Veriyi Filtrele (Se√ßili Ay)
    const filtered = data.filter(item => {
        // item.date formatƒ± "dd.mm.yyyy" varsayƒ±lƒ±yor
        if(!item.date) return false;
        const parts = item.date.split('.'); // [dd, mm, yyyy]
        if(parts.length < 3) return false;
        const itemMonthKey = `${parts[1]}.${parts[2]}`;
        return itemMonthKey === monthFilter;
    });

    // 2. ƒ∞statistikleri Hesapla
    let totalScore = 0;
    let count = filtered.length;
    let scores = filtered.map(i => parseInt(i.score) || 0);
    
    if (count > 0) {
        totalScore = scores.reduce((a, b) => a + b, 0);
    }
    
    const average = count > 0 ? (totalScore / count).toFixed(1) : 0;
    const targetRate = count > 0 ? ((scores.filter(s => s >= 90).length / count) * 100).toFixed(0) : 0;

    // 3. Kartlarƒ± G√ºncelle
    document.getElementById('dash-total-score').innerText = average;
    document.getElementById('dash-total-count').innerText = count;
    document.getElementById('dash-target-rate').innerText = `%${targetRate}`;
    
    // Renklendirme
    const scoreEl = document.getElementById('dash-total-score');
    if(average >= 90) scoreEl.style.color = 'var(--success)';
    else if(average >= 80) scoreEl.style.color = 'var(--warning)';
    else scoreEl.style.color = 'var(--accent)';

    // 4. Listeyi Doldur (Son 5 Kayƒ±t)
    const listEl = document.getElementById('evaluations-list-dashboard');
    listEl.innerHTML = '';
    
    if (count === 0) {
        listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">Bu d√∂nem i√ßin kayƒ±t yok.</div>';
    } else {
        // En yeniden eskiye
        const sorted = filtered.reverse().slice(0, 10); 
        sorted.forEach(item => {
            let badgeClass = item.score >= 90 ? 'score-green' : (item.score >= 70 ? 'score-yellow' : 'score-red');
            let html = `
                <div class="dash-list-item">
                    <div>
                        <div style="font-weight:bold; color:#333;">${item.callId || 'ID Yok'}</div>
                        <div style="font-size:0.75rem; color:#999;">${item.date}</div>
                    </div>
                    <div>
                        <span class="dash-score-badge ${badgeClass}">${item.score}</span>
                    </div>
                </div>`;
            listEl.innerHTML += html;
        });
    }

    // 5. Grafiƒüi √áiz
    drawChart(filtered);
}

function drawChart(data) {
    const ctx = document.getElementById('qualityChart').getContext('2d');
    
    // √ñnceki grafiƒüi temizle
    if (qualityChartInstance) {
        qualityChartInstance.destroy();
    }

    // Veriyi grafiƒüe hazƒ±rla (Tarihe g√∂re sƒ±ralƒ± skorlar)
    // Data zaten tersten gelmi≈üti (yeniden eskiye), grafik i√ßin eskinden yeniye √ßevirelim
    const chartData = [...data].reverse();
    const labels = chartData.map(d => d.date.split('.')[0] + '/' + d.date.split('.')[1]); // Sadece G√ºn/Ay
    const points = chartData.map(d => d.score);

    qualityChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Kalite Puanƒ±',
                data: points,
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.3,
                fill: true,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#3B82F6',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: { display: true, text: 'Puan Trendi' }
            },
            scales: {
                y: { min: 0, max: 100 }
            }
        }
    });
}

// Placeholder fonksiyonlar (Hata vermemesi i√ßin)
function toggleEditMode() {} 
function addNewCardPopup() {}
function changePasswordPopup() {}
</script>
</body>
</html>
